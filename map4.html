<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.6, maximum-scale=1, viewport-fit=cover">
    <title>ÿßŸÑŸÇÿ∑ÿßÿ± - Train Journey</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    html, body { width:100%;  font-family: -apple-system, BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; touch-action:manipulation; -webkit-font-smoothing:antialiased;}

        body {
            background: linear-gradient(180deg, #87CEEB 0%, #cce6fd 100%);
            animation: dayTime 40s linear infinite;
            touch-action: manipulation;
        }

        /* Top navigation */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, rgba(25, 118, 210, 0.95), rgba(33, 150, 243, 0.95));
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            color: white;
        }

        .nav-title {
            font-size: 18px;
            font-weight: bold;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .nav-btn.logout {
            background: rgba(220, 53, 69, 0.8);
        }

        .nav-btn.logout:hover {
            background: rgba(220, 53, 69, 1);
        }

        /* Adjust body padding for fixed nav */
        .sky {
            margin-top: 60px;
            height: calc(100vh - 60px);
        }

.stage{
    left:35%;
    transform: translateX(-35%);
}
        /* Mobile-optimized controls */
    .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: #205c6b;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .control-btn:hover, .control-btn:active {
            background: #2a7a8a;
            transform: scale(0.95);
        }

        .control-btn.active {
            background: #ff6b6b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }



        /*CLOUDS - Enhanced for mobile*/
        .sky {
            position: relative;
            width: 100%;
            height: 100vh;
        }

        .cloud {
            position: absolute;
            opacity: 0.8;
        }

        .cloud:before,
        .cloud:after {
            position: absolute;
            content: '';
        }

        .cloud,
        .cloud:before,
        .cloud:after {
            background: #fff;
            border-radius: 50%;
            border: 15px solid #fff;
            height: 20px;
            width: 30px;
        }

        .cloud:before {
            left: -20px;
            bottom: -30px;
            border-width: 18px;
        }

        .cloud:after {
            right: -15px;
            bottom: -45px;
            border-width: 16px;
        }

        .cloud:nth-child(1) {
            top: 10%;
            left: 20%;
            animation: windHorizontal 25s infinite linear;
        }

        .cloud:nth-child(2) {
            top: 30%;
            left: 60%;
            animation: windHorizontal 35s infinite linear;
            animation-delay: -10s;
        }

        .cloud:nth-child(3) {
            top: 60%;
            left: 10%;
            animation: windHorizontal 40s infinite linear;
            animation-delay: -20s;
        }

        /* Track line */
        .track {
            position: absolute;
            right: 60px;
            top: 0;
            height: 100vh;
            width: 6px;
            background: repeating-linear-gradient(
                to bottom,
                #8B4513 0px,
                #8B4513 15px,
                transparent 15px,
                transparent 25px
            );
            z-index: 1;
        }

        .track:after {
            content: '';
            position: absolute;
            right: -8px;
            top: 0;
            height: 100%;
            width: 22px;
            background: repeating-linear-gradient(
                to bottom,
                #696969 0px,
                #696969 8px,
                transparent 8px,
                transparent 12px
            );
            z-index: -1;
        }

        /*TRAIN - Mobile optimized*/
        .train {
            position: absolute;
            right: 2px;
            height: 80px;
            width: 200px;
            z-index: 10;
            transform: rotate(-90deg);
            transform-origin: center;
            transition: bottom 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            bottom: calc(100vh - (100vh * var(--progress-ratio, 0)));
        }

        .wagon,
        .locomotive {
            display: block;
            width: 45px;
            height: 35px;
            background: linear-gradient(45deg, #dc2626, #ef4444);
            position: relative;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .locomotive {
            background: linear-gradient(45deg, #1e40af, #3b82f6);
        }

        /*WHEELS - Mobile sized*/
        .wagon:before,
        .wagon:after,
        .locomotive:before,
        .locomotive:after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #333;
            bottom: -8px;
            background: linear-gradient(45deg, #666, #999);
            animation: spin var(--spin-speed, 2s) linear infinite;
        }

        .wagon:before,
        .locomotive:before {
            left: 4px;
        }

        .wagon:after,
        .locomotive:after {
            right: 4px;
        }

        /* Locomotive details */
        .locomotive .cabin {
            width: 35px;
            height: 20px;
            background: linear-gradient(45deg, #1e40af, #3b82f6);
            border-radius: 4px 4px 0 0;
            position: relative;
        }

        .locomotive .cabin:before {
            content: '';
            width: 15px;
            height: 10px;
            position: absolute;
            top: 3px;
            left: 10px;
            border-radius: 2px;
            border: 1px solid #fff;
            background: rgba(255, 255, 255, 0.8);
        }

        .locomotive .chimney {
            position: absolute;
            display:none;
            width: 8px;
            height: 8px;
            background: #333333;
            right: 5px;
            top: -6px;
            border-radius: 2px;
        }

        .locomotive .chimney:after {
            content: 'üí®';
            position: absolute;
            top: -15px;
            left: 15px;
            font-size: 12px;
            animation: smoke 2s infinite;
        }

        /* Stations - Mobile optimized */
        .stations {
            position: absolute;
            right: -20px;
            top: 0;
            height: 100vh;
            width: 60px;
            z-index: 100;
            pointer-events: auto;
        }

    .station {
            position: absolute;
            right: 0;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #fff, #f8f9fa);
            border: 3px solid #205c6b;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .station.locked {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            border-color: #dc3545;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .station.locked .station-label {
            color: #dc3545;
        }

        .station.locked::after {
            content: 'üîí';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 12px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .station:not(.locked):hover,
        .station:not(.locked):active {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .station-label {
            font-size: 18px;
            color: #205c6b;
            font-weight: bold;
        }

        /* Level Information Popup */
        .level-info {
            position: absolute;
            left: -300px;
            top: 50%;
            transform: translateY(-50%);
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #205c6b;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }

        .level-info.show {
            opacity: 1;
            visibility: visible;
            left: -320px;
            pointer-events: auto;
        }

        .level-info h3 {
            color: #205c6b;
            font-size: 18px;
            margin-bottom: 10px;
            border-bottom: 2px solid #205c6b;
            padding-bottom: 8px;
        }

        .level-info p {
            margin: 8px 0;
            font-size: 14px;
            color: #333;
        }

        .level-info .description {
            font-style: italic;
            color: #666;
            margin-bottom: 12px;
        }

        .level-info .date {
            font-weight: bold;
            color: #205c6b;
        }

        .level-info .tickets {
            color: #10b981;
            font-weight: bold;
        }

        .level-info .tickets.limited {
            color: #ff6b6b;
        }

        .level-info .tickets.sold-out {
            color: #dc3545;
            font-weight: bold;
        }

        .booking-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(45deg, #10b981, #34d399);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
            font-size: 14px;
        }

        .booking-btn:hover {
            background: linear-gradient(45deg, #059669, #10b981);
            transform: translateY(-2px);
        }

        .booking-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .booking-btn.sold-out {
            background: #dc3545;
            cursor: not-allowed;
        }

        .booking-btn.cancel {
            background: linear-gradient(45deg, #ff6b6b, #ff8787);
            color: white;
        }

        .booking-btn.cancel:hover {
            background: linear-gradient(45deg, #ff5252, #ff6b6b);
            transform: translateY(-2px);
        }

        .level-info .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            color: #205c6b;
            cursor: pointer;
            padding: 0;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .level-info .close-btn:hover {
            color: #ff6b6b;
        }

        /* Loading indicator */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 2000;
            display: none;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        /* Progress bar */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 100;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            width: 0%;
            transition: width 0.3s ease;
        }

        /*ANIMATIONS*/
        @keyframes dayTime {
            0% { background: linear-gradient(180deg, #87CEEB 0%, #cce6fd 100%); }
            50% { background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); }
            100% { background: linear-gradient(180deg, #87CEEB 0%, #cce6fd 100%); }
        }

        @keyframes windHorizontal {
            0% { transform: translateX(-100px); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateX(calc(100vw + 100px)); opacity: 0; }
        }

        @keyframes voyageVertical {
            0% { bottom: calc(100vh - (100vh * 0)); }
            100% { bottom: calc(100vh - (100vh * var(--max-progress-ratio, 1))); }
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        @keyframes smoke {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-20px) scale(1.5); }
        }

        .train.moving {
            animation: voyageVertical var(--journey-duration, s) linear infinite;
        }

        /* Mobile landscape adjustments */
    @media screen and (orientation: landscape) and (max-height: 500px) {
            .controls {
                bottom: 10px;
                scale: 0.9;
            }
            

            
            .stations {
                right: 70px;
            }
            
            .station {
                width: 40px;
                height: 40px;
            }
            
            .station-label {
                font-size: 14px;
            }

        }

        /* Small phones portrait */
        @media (max-width:480px){
            .controls {bottom:14px; gap:8px; padding:8px 10px;}
            .control-btn {width:46px; height:46px; font-size:16px;}
            .station {width:42px; height:42px;}
            .station-label {font-size:15px;}
            .train {width:170px; height:70px;}
        }

        /* Ultra narrow */
        @media (max-width:340px){
            .control-btn {width:42px; height:42px;}
            .station {width:38px; height:38px;}
        }

        /* Dark mode subtle adjustments */
        @media (prefers-color-scheme: dark){
            body {background: linear-gradient(180deg,#0f2027 0%, #203a43 50%, #2c5364 100%);}
            .station {background: linear-gradient(45deg,#374151,#4b5563); border-color:#2dd4bf;}
            .station-label {color:#e0f2fe;}
            .controls {background:rgba(0,0,0,0.75);}            
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .controls {
                background: rgba(0, 0, 0, 0.8);
            }
            

        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <div class="top-nav">
        <div class="nav-title">ÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑŸÉŸÜÿ≤ - Journey03</div>
        <div class="nav-buttons">
            <a href="profile.html" class="nav-btn">ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</a>
            <button onclick="logout()" class="nav-btn logout">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>
        </div>
    </div>

    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Loading indicator -->
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Check if user is logged in before initializing Firebase
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) {
            alert('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ Ÿáÿ∞Ÿá ÿßŸÑÿµŸÅÿ≠ÿ©');
            window.location.href = 'index.html';
        }

        // Firebase configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, update, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBHp8tHdlNoykCrMFZvl1gJKwcIGLcJ8gM",
    authDomain: "journey03-ed32f.firebaseapp.com",
    databaseURL: "https://journey03-ed32f-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "journey03-ed32f",
    storageBucket: "journey03-ed32f.firebasestorage.app",
    messagingSenderId: "637158543040",
    appId: "1:637158543040:web:4ddfd0c0bc412cb6716725",
    measurementId: "G-PPVXVYL8E2"
};

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase functions globally available
        window.database = database;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        window.firebaseChild = child;
        
        // Signal that Firebase is ready
        window.firebaseReady = true;
        
        // Dispatch custom event when Firebase is ready
        window.dispatchEvent(new CustomEvent('firebaseReady'));
    </script>

    <section class="stage">
        <div class="sky">
            <div class="cloud"></div>
            <div class="cloud"></div>
            <div class="cloud"></div>
        </div>
        
        <div class="track"></div>
        
        <!-- Stations positioned vertically -->
        <div class="stations">
            <div class="station" style="top: 5%;" data-station="1" onclick="toggleLevelInfo(1)">
                <span class="station-label">1</span>
                <div class="level-info" id="level-info-1">
                    <button class="close-btn" onclick="closeLevelInfo(1, event)">√ó</button>
                    <h3>ÿØŸàÿ≥ ÿ≥ÿ™ÿßÿ±ÿ™</h3>
                    <p class="description">ŸÑÿπÿ® Ÿà ŸÅŸÇÿ±ÿßÿ™ ÿ∑ÿ®Ÿäÿ© Ÿà ÿ™ŸÖÿ±ÿ±ÿ±ÿ±</p>
                    <p class="date">Date: March 22, 2025</p>
                    <p class="tickets" id="tickets-1">Available Tickets: <span id="ticket-count-1">80</span></p>
                    <button class="booking-btn" id="book-btn-1" onclick="bookLevel(1, event)">ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿßŸÜ</button>
                </div>
            </div>
            <div class="station" style="top: 20%;" data-station="2" onclick="toggleLevelInfo(2)">
                <span class="station-label">2</span>
                <div class="level-info" id="level-info-2">
                    <button class="close-btn" onclick="closeLevelInfo(2, event)">√ó</button>
                    <h3>ŸáŸàÿ®ÿß  ÿ™Ÿäÿ™Ÿà ŸÖÿßŸÖÿ®Ÿà</h3>
                    <p class="description">ŸÉŸäŸÉÿ© Ÿà ŸÖÿßŸÜÿ¨ÿß Ÿà ÿµŸàÿµ ÿßŸÑÿ¥ŸàŸÉŸÑÿßÿ™ÿ© ÿßŸÑÿ®ŸÑÿ¨ŸäŸÉŸä</p>
                    <p class="date">Date: March 29, 2025</p>
                    <p class="tickets" id="tickets-2">Available Tickets: <span id="ticket-count-2">80</span></p>
                    <button class="booking-btn" id="book-btn-2" onclick="bookLevel(2, event)">ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿßŸÜ</button>
                </div>
            </div>
            <div class="station" style="top: 35%;" data-station="3" onclick="toggleLevelInfo(3)">
                <span class="station-label">3</span>
                <div class="level-info" id="level-info-3">
                    <button class="close-btn" onclick="closeLevelInfo(3, event)">√ó</button>
                    <h3>Object-Oriented Programming</h3>
                    <p class="description">Understand OOP principles, inheritance, polymorphism, and encapsulation</p>
                    <p class="date">Date: March 5, 2024</p>
                    <p class="tickets limited" id="tickets-3">Available Tickets: <span id="ticket-count-3">5</span></p>
                    <button class="booking-btn" id="book-btn-3" onclick="bookLevel(3, event)">ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿßŸÜ</button>
                </div>
            </div>
            <div class="station" style="top: 50%;" data-station="4" onclick="toggleLevelInfo(4)">
                <span class="station-label">4</span>
                <div class="level-info" id="level-info-4">
                    <button class="close-btn" onclick="closeLevelInfo(4, event)">√ó</button>
                    <h3>Data Structures & Algorithms</h3>
                    <p class="description">Explore arrays, linked lists, trees, sorting, and searching algorithms</p>
                    <p class="date">Date: February 28, 2024</p>
                    <p class="tickets" id="tickets-4">Available Tickets: <span id="ticket-count-4">32</span></p>
                    <button class="booking-btn" id="book-btn-4" onclick="bookLevel(4, event)">ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿßŸÜ</button>
                </div>
            </div>
            <div class="station" style="top: 70%;" data-station="5" onclick="toggleLevelInfo(5)">
                <span class="station-label">5</span>
                <div class="level-info" id="level-info-5">
                    <button class="close-btn" onclick="closeLevelInfo(5, event)">√ó</button>
                    <h3>Programming Fundamentals</h3>
                    <p class="description">Learn basic programming concepts, variables, loops, and functions</p>
                    <p class="date">Date: February 20, 2024</p>
                    <p class="tickets" id="tickets-5">Available Tickets: <span id="ticket-count-5">45</span></p>
                    <button class="booking-btn" id="book-btn-5" onclick="bookLevel(5, event)">ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿßŸÜ</button>
                </div>
            </div>
            <div class="station" style="top: 90%;" data-station="6" onclick="toggleLevelInfo(6)">
                <span class="station-label">6</span>
                <div class="level-info" id="level-info-6">
                    <button class="close-btn" onclick="closeLevelInfo(6, event)">√ó</button>
                    <h3>Introduction to Computing</h3>
                    <p class="description">Basic computer concepts, introduction to programming logic</p>
                    <p class="date">Date: February 15, 2024</p>
                    <p class="tickets limited" id="tickets-6">Available Tickets: <span id="ticket-count-6">8</span></p>
                    <button class="booking-btn" id="book-btn-6" onclick="bookLevel(6, event)">ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿßŸÜ</button>
                </div>
            </div>
        </div>
        
        <div class="train" id="train">
            <div class="locomotive">
                <div class="cabin"></div>
                <div class="chimney"></div>
            </div>
            <div class="wagon"></div>
            <div class="wagon"></div>
            <div class="wagon"></div>
        </div>
    </section>



    <script>
        let isPlaying = true;
        let currentStation = 1;
        let journeyProgress = 0;
        let maxAllowedStation = 1; // Default to only first station accessible for new teams
        // Train speed control (multiplier). 1 = normal speed
        let trainSpeed = 8;
        const BASE_PROGRESS_INCREMENT = 100 / (20 * 60); // existing base increment per tick
    // Debug mode
    let debugMode = false;
    let lastLoggedStation = null;

        /**
         * Adjust the train speed.
         * @param {number} multiplier - Desired speed multiplier (e.g. 0.5 slow, 1 normal, 2 double speed)
         * Values are clamped between 0 (stops movement) and 5 (max 5x).
         */
        function setTrainSpeed(multiplier) {
            if (typeof multiplier !== 'number' || isNaN(multiplier)) return;
            // Clamp
            trainSpeed = Math.max(0, Math.min(5, multiplier));
            // Update wheel spin animation speed (inverse relation)
            // Base spin is 2s at 1x; faster speed -> shorter duration.
            const baseSpinSeconds = 2;
            const spinDuration = trainSpeed === 0 ? '0s' : (baseSpinSeconds / trainSpeed).toFixed(2) + 's';
            train.style.setProperty('--spin-speed', spinDuration);
        }

        // Optional helpers (not required but handy if you want incremental control)
        function increaseTrainSpeed(step = 0.25) { setTrainSpeed(trainSpeed + step); }
        function decreaseTrainSpeed(step = 0.25) { setTrainSpeed(trainSpeed - step); }
        
        const train = document.getElementById('train');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const progressBar = document.getElementById('progressBar');

        // Utility functions for loading states
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Initialize on page load
        async function initializePage() {
            try {
                await updateMaxAllowedStation();
                await initializeTicketCounts(); // Initialize ticket counts
                await updateBookingButtonStates(); // Update booking button states
                updateTrainPosition();
                
                // Set initial train position to station 1
                if (journeyProgress === 0) {
                    journeyProgress = 10; // Start at station 1 position
                    const progressRatio = journeyProgress / 100;
                    train.style.setProperty('--progress-ratio', progressRatio);
                    progressBar.style.width = `${(journeyProgress / 95) * 100}%`;
                }
            } catch (error) {
                console.error('Error initializing page:', error);
                hideLoading();
            }
        }

        // Wait for Firebase to load, then initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Firebase is already ready
            if (window.firebaseReady) {
                initializePage();
            } else {
                // Wait for Firebase ready event
                window.addEventListener('firebaseReady', initializePage);
                
                // Fallback timeout after 5 seconds
                setTimeout(() => {
                    if (!window.firebaseReady) {
                        console.error('Firebase failed to load within timeout');
                        hideLoading();
                        // Initialize with defaults (no Firebase functionality)
                        updateTrainPosition();
                        if (journeyProgress === 0) {
                            journeyProgress = 10;
                            const progressRatio = journeyProgress / 100;
                            train.style.setProperty('--progress-ratio', progressRatio);
                            progressBar.style.width = `${(journeyProgress / 95) * 100}%`;
                        }
                    }
                }, 5000);
            }
        });

        // Function to get the highest accessible station for current user's team
        async function updateMaxAllowedStation() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                maxAllowedStation = 1; // Default only first station open if no user
                updateStationVisuals();
                return;
            }

            // Check if Firebase is available
            if (!window.firebaseReady || !window.database) {
                console.log('Firebase not ready, using defaults');
                maxAllowedStation = 1; // Default only first station open if Firebase not ready
                updateStationVisuals();
                return;
            }

            try {
                showLoading();
                
                // Create email key for Firebase
                const emailKey = currentUser.replace(/\./g, '_').replace(/@/g, '_at_');
                
                // Get user data from Firebase
                const dbRef = window.firebaseRef(window.database);
                const userSnapshot = await window.firebaseGet(window.firebaseChild(dbRef, `users/${emailKey}`));
                
                if (!userSnapshot.exists()) {
                    maxAllowedStation = 1; // Default only first station open if no user data
                    updateStationVisuals();
                    return;
                }
                
                const user = userSnapshot.val();
                
                if (!user || !user.team) {
                    maxAllowedStation = 1; // Default only first station open if no team
                    updateStationVisuals();
                    return;
                }

                // Get level settings from Firebase
                const levelSettingsSnapshot = await window.firebaseGet(window.firebaseChild(dbRef, `levelSettings/${user.team}`));
                const teamSettings = levelSettingsSnapshot.exists() ? levelSettingsSnapshot.val() : {};

                // Find the last consecutive accessible station starting from level 1
                maxAllowedStation = 1; // Start with level 1 as minimum
                
                // Check each level consecutively from 1 upward
                for (let station = 1; station <= 6; station++) {
                    if (canAccessLevel(teamSettings, station)) {
                        maxAllowedStation = station; // Update to this station if accessible
                    } else {
                        // Stop at first locked station - don't go beyond it
                        break;
                    }
                }
                updateStationVisuals(user.team);
                
            } catch (error) {
                console.error('Error updating max allowed station:', error);
                maxAllowedStation = 1; // Default only first station open on error
                updateStationVisuals();
            } finally {
                hideLoading();
            }
        }

        // Initialize ticket counts from Firebase or set defaults
        async function initializeTicketCounts() {
            // Check if Firebase is available
            if (!window.firebaseReady || !window.database) {
                console.log('Firebase not ready for ticket initialization');
                return;
            }

            try {
                const dbRef = window.firebaseRef(window.database);
                const ticketsSnapshot = await window.firebaseGet(window.firebaseChild(dbRef, 'tickets'));
                
                // Default ticket counts for each level
                const defaultTickets = {
                    1: 80,
                    2: 80,
                    3: 80,
                    4: 80,
                    5: 80,
                    6: 80
                };
                
                let ticketsData = {};
                
                if (ticketsSnapshot.exists()) {
                    ticketsData = ticketsSnapshot.val();
                } else {
                    // Initialize with default values if not exists
                    ticketsData = defaultTickets;
                    await window.firebaseSet(window.firebaseRef(window.database, 'tickets'), ticketsData);
                }
                
                // Update UI with current ticket counts
                for (let level = 1; level <= 6; level++) {
                    updateTicketDisplay(level, ticketsData[level] || 0);
                }
                
            } catch (error) {
                console.error('Error initializing ticket counts:', error);
                // Fallback to default display if Firebase fails
                const defaultTickets = {1: 80, 2: 80, 3: 80, 4: 80, 5: 80, 6: 80};
                for (let level = 1; level <= 6; level++) {
                    updateTicketDisplay(level, defaultTickets[level]);
                }
            }
        }

        // Update ticket display in UI
        function updateTicketDisplay(levelId, ticketCount) {
            const ticketCountSpan = document.getElementById(`ticket-count-${levelId}`);
            const ticketsElement = document.getElementById(`tickets-${levelId}`);
            const bookingBtn = document.getElementById(`book-btn-${levelId}`);
            
            if (ticketCountSpan) {
                ticketCountSpan.textContent = ticketCount;
            }
            
            if (ticketsElement && bookingBtn) {
                if (ticketCount <= 0) {
                    // Sold out
                    ticketsElement.classList.add('sold-out');
                    ticketsElement.classList.remove('limited');
                    bookingBtn.disabled = true;
                    bookingBtn.textContent = 'Sold Out';
                    bookingBtn.classList.add('sold-out');
                } else if (ticketCount <= 10) {
                    // Limited tickets
                    ticketsElement.classList.add('limited');
                    ticketsElement.classList.remove('sold-out');
                    bookingBtn.disabled = false;
                    bookingBtn.textContent = 'ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿßŸÜ';
                    bookingBtn.classList.remove('sold-out');
                } else {
                    // Normal availability
                    ticketsElement.classList.remove('limited', 'sold-out');
                    bookingBtn.disabled = false;
                    bookingBtn.textContent = 'ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿßŸÜ';
                    bookingBtn.classList.remove('sold-out');
                }
            }
        }

        // Decrement ticket count when booking is made
        async function decrementTicket(levelId) {
            // Check if Firebase is available
            if (!window.firebaseReady || !window.database) {
                console.log('Firebase not ready for ticket decrement');
                return false;
            }

            try {
                const dbRef = window.firebaseRef(window.database);
                const ticketRef = window.firebaseChild(dbRef, `tickets/${levelId}`);
                const ticketSnapshot = await window.firebaseGet(ticketRef);
                
                if (ticketSnapshot.exists()) {
                    const currentCount = ticketSnapshot.val();
                    
                    if (currentCount > 0) {
                        // Decrement the ticket count
                        const newCount = currentCount - 1;
                        await window.firebaseSet(window.firebaseRef(window.database, `tickets/${levelId}`), newCount);
                        
                        // Update UI
                        updateTicketDisplay(levelId, newCount);
                        
                        // Also update other users by refreshing ticket counts periodically
                        setTimeout(() => refreshTicketCounts(), 1000);
                        
                        return true;
                    } else {
                        alert('ÿπÿ∞ÿ±ÿßŸãÿå ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿ∞ÿßŸÉÿ± ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©');
                        return false;
                    }
                } else {
                    console.error('Ticket data not found for level', levelId);
                    return false;
                }
                
            } catch (error) {
                console.error('Error decrementing ticket:', error);
                return false;
            }
        }

        // Increment ticket count when booking is cancelled
        async function incrementTicket(levelId) {
            // Check if Firebase is available
            if (!window.firebaseReady || !window.database) {
                console.log('Firebase not ready for ticket increment');
                return false;
            }

            try {
                const dbRef = window.firebaseRef(window.database);
                const ticketRef = window.firebaseChild(dbRef, `tickets/${levelId}`);
                const ticketSnapshot = await window.firebaseGet(ticketRef);
                
                if (ticketSnapshot.exists()) {
                    const currentCount = ticketSnapshot.val();
                    
                    // Increment the ticket count
                    const newCount = currentCount + 1;
                    await window.firebaseSet(window.firebaseRef(window.database, `tickets/${levelId}`), newCount);
                    
                    // Update UI
                    updateTicketDisplay(levelId, newCount);
                    
                    // Also update other users by refreshing ticket counts periodically
                    setTimeout(() => refreshTicketCounts(), 1000);
                    
                    return true;
                } else {
                    console.error('Ticket data not found for level', levelId);
                    return false;
                }
                
            } catch (error) {
                console.error('Error incrementing ticket:', error);
                return false;
            }
        }

        // Refresh ticket counts from Firebase (for real-time updates)
        async function refreshTicketCounts() {
            if (!window.firebaseReady || !window.database) return;

            try {
                const dbRef = window.firebaseRef(window.database);
                const ticketsSnapshot = await window.firebaseGet(window.firebaseChild(dbRef, 'tickets'));
                
                if (ticketsSnapshot.exists()) {
                    const ticketsData = ticketsSnapshot.val();
                    
                    // Update UI for all levels
                    for (let level = 1; level <= 6; level++) {
                        if (ticketsData[level] !== undefined) {
                            updateTicketDisplay(level, ticketsData[level]);
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error refreshing ticket counts:', error);
            }
        }

        // Update booking button states based on user's current bookings
        async function updateBookingButtonStates() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser || !window.firebaseReady || !window.database) {
                return;
            }

            try {
                const emailKey = currentUser.replace(/\./g, '_').replace(/@/g, '_at_');
                const dbRef = window.firebaseRef(window.database);
                const userSnapshot = await window.firebaseGet(window.firebaseChild(dbRef, `users/${emailKey}`));
                
                if (userSnapshot.exists()) {
                    const user = userSnapshot.val();
                    const userBookings = user.bookings || [];
                    
                    // Update button states for all levels
                    for (let level = 1; level <= 6; level++) {
                        const bookingBtn = document.getElementById(`book-btn-${level}`);
                        const existingBooking = userBookings.find(b => b.levelId == level);
                        
                        if (bookingBtn && !bookingBtn.classList.contains('sold-out')) {
                            if (existingBooking) {
                                // User has booked this level - show cancel button
                                bookingBtn.textContent = 'ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ¨ÿ≤';
                                bookingBtn.classList.add('cancel');
                                bookingBtn.classList.remove('sold-out');
                                bookingBtn.disabled = false;
                            } else {
                                // User hasn't booked - show book button
                                bookingBtn.textContent = 'ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿßŸÜ';
                                bookingBtn.classList.remove('cancel');
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error updating booking button states:', error);
            }
        }

        // Function to update station visual appearance based on lock status
        async function updateStationVisuals(userTeam = null) {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) return;

            // Check if Firebase is available
            if (!window.firebaseReady || !window.database) {
                console.log('Firebase not ready for station visuals');
                return;
            }

            try {
                let team = userTeam;
                
                if (!team) {
                    // Get user team from Firebase if not provided
                    const emailKey = currentUser.replace(/\./g, '_').replace(/@/g, '_at_');
                    const dbRef = window.firebaseRef(window.database);
                    const userSnapshot = await window.firebaseGet(window.firebaseChild(dbRef, `users/${emailKey}`));
                    
                    if (!userSnapshot.exists()) return;
                    const user = userSnapshot.val();
                    team = user.team;
                }
                
                if (!team) return;

                // Get level settings from Firebase
                const dbRef = window.firebaseRef(window.database);
                const levelSettingsSnapshot = await window.firebaseGet(window.firebaseChild(dbRef, `levelSettings/${team}`));
                const teamSettings = levelSettingsSnapshot.exists() ? levelSettingsSnapshot.val() : {};

                // Update each station's appearance
                for (let station = 1; station <= 6; station++) {
                    const stationElement = document.querySelector(`[data-station="${station}"]`);
                    if (stationElement) {
                        const isAccessible = canAccessLevel(teamSettings, station);
                        if (isAccessible) {
                            stationElement.classList.remove('locked');
                        } else {
                            stationElement.classList.add('locked');
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error updating station visuals:', error);
            }
        }

        // Function to update train position based on accessible stations
        function updateTrainPosition() {
            // Map stations to their exact positions (from bottom of screen)
            const stationPositions = {
                1: 10,   // Station 1 at 90% from top = 10% from bottom
                2: 20,   // Station 2 at 70% from top = 30% from bottom  
                3: 33,   // Station 3 at 50% from top = 50% from bottom
                4: 48,   // Station 4 at 35% from top = 65% from bottom
                5: 68,   // Station 5 at 20% from top = 80% from bottom
                6: 90    // Station 6 at 5% from top = 95% from bottom
            };
            
            const targetPosition = stationPositions[maxAllowedStation];
            
            // If current progress exceeds max allowed, reset to max allowed station position
            if (journeyProgress > targetPosition) {
                journeyProgress = targetPosition;
                progressBar.style.width = `${(journeyProgress / 95) * 100}%`; // Normalize progress bar
                
                // Update train position to exact station position
                const progressRatio = journeyProgress / 100;
                train.style.setProperty('--progress-ratio', progressRatio);
            }
        }



        function togglePlayPause() {
            isPlaying = !isPlaying;
            
            if (isPlaying) {
                train.style.animationPlayState = 'running';
                playPauseBtn.innerHTML = '‚è∏Ô∏è';
                playPauseBtn.classList.remove('active');
            } else {
                train.style.animationPlayState = 'paused';
                playPauseBtn.classList.add('active');
            }
        }



        function selectStation(stationNumber) {
            // Simply set the current station number
            currentStation = stationNumber;
            
            // Haptic feedback on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        async function toggleLevelInfo(levelNumber) {
            // Check if user is logged in and get their team
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                try {
                    const emailKey = currentUser.replace(/\./g, '_').replace(/@/g, '_at_');
                    const dbRef = window.firebaseRef(window.database);
                    const userSnapshot = await window.firebaseGet(window.firebaseChild(dbRef, `users/${emailKey}`));
                    
                    if (userSnapshot.exists()) {
                        const user = userSnapshot.val();
                        
                        // Check if level is locked for this user's team
                        if (user && user.team && !(await canAccessLevelFromFirebase(user.team, levelNumber))) {
                            alert('Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ŸÖÿ∫ŸÑŸÇÿ© ÿ≠ÿßŸÑŸäÿßŸã ŸÑŸÅÿ±ŸäŸÇŸÉ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã.');
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Error checking user access:', error);
                }
            }
            
            // Check if station element is locked (visual check)
            const stationElement = document.querySelector(`[data-station="${levelNumber}"]`);
            if (stationElement && stationElement.classList.contains('locked')) {
                alert('Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ŸÖÿ∫ŸÑŸÇÿ© ÿ≠ÿßŸÑŸäÿßŸã. ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸäŸáÿß.');
                return;
            }

            // Check if tickets are sold out
            const bookingBtn = document.getElementById(`book-btn-${levelNumber}`);
            if (bookingBtn && bookingBtn.classList.contains('sold-out')) {
                // Still allow viewing info, but show sold out message if they try to book
                console.log(`Level ${levelNumber} is sold out but info can still be viewed`);
            }
            
            // Close all other level info panels first
            document.querySelectorAll('.level-info').forEach(info => {
                info.classList.remove('show');
            });
            
            // Toggle the clicked level info
            const levelInfo = document.getElementById(`level-info-${levelNumber}`);
            levelInfo.classList.add('show');
            
            // Set current station
            currentStation = levelNumber;
            
            // Haptic feedback on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        function closeLevelInfo(levelNumber, event) {
            // Prevent the station click event from firing
            event.stopPropagation();
            
            const levelInfo = document.getElementById(`level-info-${levelNumber}`);
            levelInfo.classList.remove('show');
        }

        async function bookLevel(levelNumber, event) {
            // Prevent the station click event from firing
            event.stopPropagation();
            
            // Check if user is logged in
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                alert('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã ŸÑÿ•ÿ¨ÿ±ÿßÿ° ÿßŸÑÿ≠ÿ¨ÿ≤');
                window.location.href = 'index.html';
                return;
            }
            
            try {
                const dbRef = window.firebaseRef(window.database);
                const emailKey = currentUser.replace(/\./g, '_').replace(/@/g, '_at_');
                
                // Get user data from Firebase
                const userSnapshot = await window.firebaseGet(window.firebaseChild(dbRef, `users/${emailKey}`));
                
                if (!userSnapshot.exists()) {
                    alert('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                    return;
                }
                
                const user = userSnapshot.val();
                
                // Check if level is locked for this user's team
                if (user && user.team && !(await canAccessLevelFromFirebase(user.team, levelNumber))) {
                    alert('Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ŸÖÿ∫ŸÑŸÇÿ© ÿ≠ÿßŸÑŸäÿßŸã ŸÑŸÅÿ±ŸäŸÇŸÉ. ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸäŸáÿß.');
                    return;
                }
                
                // Get level information
                const levelNames = {
                    1: "ÿØŸàÿ≥ ÿ≥ÿ™ÿßÿ±ÿ™",
                    2: "ŸáŸàÿ®ÿß ÿ™Ÿäÿ™Ÿà ŸÖÿßŸÖÿ®Ÿà", 
                    3: "Object-Oriented Programming",
                    4: "Data Structures & Algorithms",
                    5: "Programming Fundamentals",
                    6: "Introduction to Computing"
                };
                
                const levelName = levelNames[levelNumber];
                
                // Check if user has already booked this level
                const userBookings = user.bookings || [];
                const existingBooking = userBookings.find(b => b.levelId == levelNumber);
                
                if (existingBooking) {
                    // User wants to cancel booking
                    if (confirm(`ÿ•ŸÑÿ∫ÿßÿ° ÿ≠ÿ¨ÿ≤ "${levelName}" (ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ${levelNumber})ÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ¨ÿ≤ Ÿàÿ≤ŸäÿßÿØÿ© ÿπÿØÿØ ÿßŸÑÿ™ÿ∞ÿßŸÉÿ± ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©.`)) {
                        // First increment the ticket count
                        const ticketIncremented = await incrementTicket(levelNumber);
                        
                        if (ticketIncremented) {
                            // Then remove booking from user's record
                            await removeBookingFromUserFirebase(currentUser, levelNumber);
                            
                            // Update button state
                            const bookingBtn = document.getElementById(`book-btn-${levelNumber}`);
                            if (bookingBtn) {
                                bookingBtn.textContent = 'ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿßŸÜ';
                                bookingBtn.classList.remove('cancel');
                            }
                            
                            // Show success message
                            alert(`ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ¨ÿ≤ ŸÑŸÑŸÖÿ±ÿ≠ŸÑÿ© ${levelNumber}: ${levelName}!\n\nÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ÿ∞ŸÉÿ±ÿ© ÿ•ŸÑŸâ ÿßŸÑÿ™ÿ∞ÿßŸÉÿ± ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©.`);
                        } else {
                            alert('ÿπÿ∞ÿ±ÿßŸãÿå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ¨ÿ≤. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
                        }
                    }
                } else {
                    // User wants to book
                    // Check if tickets are available before proceeding
                    const ticketSnapshot = await window.firebaseGet(window.firebaseChild(dbRef, `tickets/${levelNumber}`));
                    
                    if (ticketSnapshot.exists()) {
                        const ticketCount = ticketSnapshot.val();
                        if (ticketCount <= 0) {
                            alert('ÿπÿ∞ÿ±ÿßŸãÿå ŸÜŸÅÿØÿ™ ÿßŸÑÿ™ÿ∞ÿßŸÉÿ± ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸÑŸáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©');
                            return;
                        }
                    } else {
                        alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã');
                        return;
                    }
                    
                    // Show booking confirmation
                    const currentTicketCount = ticketSnapshot.val();
                    if (confirm(`ÿ≠ÿ¨ÿ≤ "${levelName}" (ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ${levelNumber})ÿü\n\nÿßŸÑÿ™ÿ∞ÿßŸÉÿ± ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©: ${currentTicketCount}\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≠ÿ¨ÿ≤ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ Ÿàÿ™ŸÇŸÑŸäŸÑ ÿπÿØÿØ ÿßŸÑÿ™ÿ∞ÿßŸÉÿ± ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©.`)) {
                        // First decrement the ticket count
                        const ticketDecremented = await decrementTicket(levelNumber);
                        
                        if (ticketDecremented) {
                            // Then add booking to user's record
                            await addBookingToUserFirebase(currentUser, levelNumber, levelName);
                            
                            // Update button state
                            const bookingBtn = document.getElementById(`book-btn-${levelNumber}`);
                            if (bookingBtn) {
                                bookingBtn.textContent = 'ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ¨ÿ≤';
                                bookingBtn.classList.add('cancel');
                            }
                            
                            // Show success message
                            const remainingTickets = currentTicketCount - 1;
                            alert(`ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ¨ÿ≤ ŸÑŸÑŸÖÿ±ÿ≠ŸÑÿ© ${levelNumber}: ${levelName}!\n\nÿßŸÑÿ™ÿ∞ÿßŸÉÿ± ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©: ${remainingTickets}\n\nŸäŸÖŸÉŸÜŸÉ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ¨ÿ≤ ŸÅŸä ÿ£Ÿä ŸàŸÇÿ™ ÿ£Ÿà ŸÖÿ±ÿßÿ¨ÿπÿ© ÿ≠ÿ¨Ÿàÿ≤ÿßÿ™ŸÉ ŸÅŸä ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä.`);
                        } else {
                            alert('ÿπÿ∞ÿ±ÿßŸãÿå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ≠ÿ¨ÿ≤. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error booking/canceling level:', error);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ®ŸÉ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
            }
        }

        // Add booking to user's record in Firebase
        async function addBookingToUserFirebase(userEmail, levelId, levelName) {
            try {
                const emailKey = userEmail.replace(/\./g, '_').replace(/@/g, '_at_');
                const userRef = window.firebaseRef(window.database, `users/${emailKey}`);
                
                // Get current user data
                const snapshot = await window.firebaseGet(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const bookings = userData.bookings || [];
                    
                    const levelDates = {
                        1: "February 15, 2024",
                        2: "February 20, 2024",
                        3: "February 28, 2024",
                        4: "March 5, 2024",
                        5: "March 10, 2024",
                        6: "March 15, 2024"
                    };
                    
                    bookings.push({
                        levelId: levelId,
                        name: levelName,
                        bookingDate: new Date().toISOString(),
                        date: levelDates[levelId],
                        time: '09:00'
                    });
                    
                    // Update bookings in Firebase
                    await window.firebaseUpdate(window.firebaseRef(window.database), {
                        [`users/${emailKey}/bookings`]: bookings
                    });
                }
            } catch (error) {
                console.error('Error adding booking to Firebase:', error);
                throw error;
            }
        }

        // Remove booking from user's record in Firebase
        async function removeBookingFromUserFirebase(userEmail, levelId) {
            try {
                const emailKey = userEmail.replace(/\./g, '_').replace(/@/g, '_at_');
                const userRef = window.firebaseRef(window.database, `users/${emailKey}`);
                
                // Get current user data
                const snapshot = await window.firebaseGet(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const bookings = userData.bookings || [];
                    
                    // Filter out the booking for this level
                    const updatedBookings = bookings.filter(b => b.levelId != levelId);
                    
                    // Update bookings in Firebase
                    await window.firebaseUpdate(window.firebaseRef(window.database), {
                        [`users/${emailKey}/bookings`]: updatedBookings
                    });
                }
            } catch (error) {
                console.error('Error removing booking from Firebase:', error);
                throw error;
            }
        }

        // Function to check if user's team can access a level from Firebase
        async function canAccessLevelFromFirebase(userTeam, levelId) {
            try {
                const dbRef = window.firebaseRef(window.database);
                const snapshot = await window.firebaseGet(window.firebaseChild(dbRef, `levelSettings/${userTeam}/${levelId}`));
                if (snapshot.exists()) {
                    return snapshot.val() === true;
                }
                return false; // Default to locked for new teams
            } catch (error) {
                console.error('Error checking level access:', error);
                return false; // Default to deny access on error
            }
        }

        // Legacy function to check if user's team can access a level (for local settings object)
        function canAccessLevel(teamSettings, levelId) {
            if (!teamSettings) {
                return false; // Default: all levels locked for new teams
            }
            return teamSettings[levelId] === true;
        }

        function updateProgress() {
            // Map stations to their exact positions (from bottom of screen)
            const stationPositions = {
                1: 10,   // Station 1 at 90% from top = 10% from bottom
                2: 20,   // Station 2 at 70% from top = 30% from bottom  
                3: 33,   // Station 3 at 50% from top = 50% from bottom
                4: 48,   // Station 4 at 35% from top = 65% from bottom
                5: 68,   // Station 5 at 20% from top = 80% from bottom
                6: 90    // Station 6 at 5% from top = 95% from bottom
            };
            
            const targetPosition = stationPositions[maxAllowedStation];
            const maxProgressForStation = targetPosition;
            
            // Only increase progress if we haven't reached the max allowed station
            if (journeyProgress < maxProgressForStation) {
                // Apply speed multiplier; speed 0 freezes movement
                const increment = BASE_PROGRESS_INCREMENT * trainSpeed;
                if (increment > 0) {
                    journeyProgress = Math.min(maxProgressForStation, journeyProgress + increment);
                }
                progressBar.style.width = `${(journeyProgress / 95) * 100}%`; // Normalize progress bar to 100%
                
                // Update train position to exact station position
                const progressRatio = journeyProgress / 100;
                train.style.setProperty('--progress-ratio', progressRatio);
            }
            
            // If we've reached the maximum allowed station, pause the train
            if (journeyProgress >= maxProgressForStation && isPlaying) {
                // Stop exactly at last allowed station and auto-pause (no return)
                journeyProgress = maxProgressForStation;
                const progressRatio = journeyProgress / 100;
                train.style.setProperty('--progress-ratio', progressRatio);
                progressBar.style.width = `${(journeyProgress / 95) * 100}%`;
                isPlaying = false;
                playPauseBtn.innerHTML = '‚ñ∂Ô∏è';
                playPauseBtn.classList.add('active');
            }
            
            // Removed reset-on-final-level logic: train now stays at last station
        }

        // Update progress periodically
        setInterval(updateProgress, 100);
        
        // Auto-update stations based on train position
        setInterval(() => {
            if (isPlaying) {
                // Map progress to station based on position ranges
                let nearestStation = 1;
                if (journeyProgress >= 85) nearestStation = 6;
                else if (journeyProgress >= 72.5) nearestStation = 5;
                else if (journeyProgress >= 57.5) nearestStation = 4;
                else if (journeyProgress >= 40) nearestStation = 3;
                else if (journeyProgress >= 20) nearestStation = 2;
                else nearestStation = 1;
                
                // Don't exceed max allowed station
                nearestStation = Math.min(nearestStation, maxAllowedStation);
                
                if (nearestStation !== currentStation) {
                    currentStation = nearestStation;
                    handleStationArrival(currentStation);
                }
            }
        }, 1000);

        // Update max allowed station when level settings change  
        setInterval(async () => {
            await updateMaxAllowedStation();
            updateTrainPosition();
        }, 3600000); // Increased interval for Firebase calls

        // Refresh ticket counts periodically for real-time updates
        setInterval(async () => {
            await refreshTicketCounts();
            await updateBookingButtonStates(); // Also update booking button states
        }, 10000); // Refresh every 10 seconds

        // Function to check if user's team can access a level (legacy for backward compatibility)
        function canAccessLevel(teamSettings, levelId) {
            if (!teamSettings) {
                return false; // Default: all levels locked for new teams
            }
            return teamSettings[levelId] === true;
        }

        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Handle orientation change
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                // Recalculate positions if needed
            }, 100);
        });

        // Debug utilities
        function toggleDebugMode(){
            debugMode = !debugMode;
            document.getElementById('trainDebugPanel').style.display = debugMode ? 'block':'none';
            document.getElementById('debugToggleBtn').classList.toggle('active', debugMode);
            if(debugMode){ logDebug('--- DEBUG ENABLED ---'); handleStationArrival(currentStation,true); }
        }
        function logDebug(msg){
            if(!debugMode) return;
            const logBox = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.textContent = `[${time}] ${msg}`;
            logBox.prepend(line); // newest on top
            // Limit lines
            while(logBox.children.length > 120){ logBox.removeChild(logBox.lastChild); }
        }
        function clearDebugPanel(){
            const logBox = document.getElementById('debugLog');
            logBox.innerHTML='';
            logDebug('Cleared');
        }
        function handleStationArrival(station,force=false){
            if(!force && station === lastLoggedStation) return; // avoid duplicates
            lastLoggedStation = station;
            const stationNames = {1:'Intro',2:'Fundamentals',3:'DSA',4:'OOP',5:'Web',6:'Advanced'};
            logDebug(`Arrived station ${station} (${stationNames[station]||'?'}) progress=${journeyProgress.toFixed(2)} allowed<=${maxAllowedStation}`);
            // Extra console output for dev tools
            if(debugMode){
                console.debug('[TrainArrival]',{station,name:stationNames[station],journeyProgress,maxAllowedStation,speed:trainSpeed});
            }
        }

        // Logout function
        function logout() {
            const confirmLogout = confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü');
            if (confirmLogout) {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }

        // Admin function to reset ticket counts (call from console: resetTickets())
        window.resetTickets = async function() {
            if (!window.firebaseReady || !window.database) {
                console.log('Firebase not ready');
                return;
            }

            const defaultTickets = {
                1: 80,
                2: 80,
                3: 80,
                4: 80,
                5: 80,
                6: 80
            };

            try {
                await window.firebaseSet(window.firebaseRef(window.database, 'tickets'), defaultTickets);
                await refreshTicketCounts();
                console.log('Ticket counts reset to default values');
            } catch (error) {
                console.error('Error resetting tickets:', error);
            }
        }

        // Admin function to set specific ticket count (call from console: setTicketCount(levelId, count))
        window.setTicketCount = async function(levelId, count) {
            if (!window.firebaseReady || !window.database) {
                console.log('Firebase not ready');
                return;
            }

            try {
                await window.firebaseSet(window.firebaseRef(window.database, `tickets/${levelId}`), count);
                updateTicketDisplay(levelId, count);
                console.log(`Set level ${levelId} tickets to ${count}`);
            } catch (error) {
                console.error('Error setting ticket count:', error);
            }
        }

        // Function to get current ticket counts (call from console: getTicketCounts())
        window.getTicketCounts = async function() {
            if (!window.firebaseReady || !window.database) {
                console.log('Firebase not ready');
                return;
            }

            try {
                const dbRef = window.firebaseRef(window.database);
                const ticketsSnapshot = await window.firebaseGet(window.firebaseChild(dbRef, 'tickets'));
                
                if (ticketsSnapshot.exists()) {
                    const tickets = ticketsSnapshot.val();
                    console.log('Current ticket counts:', tickets);
                    return tickets;
                } else {
                    console.log('No ticket data found');
                }
            } catch (error) {
                console.error('Error getting ticket counts:', error);
            }
        }
    </script>
</body>
</html>